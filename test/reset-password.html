<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì •</title>
    <style>
        /* ê¸°ì¡´ ìŠ¤íƒ€ì¼ ì¬ì‚¬ìš© */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0;
        }
        .card {
            background: white;
            border-radius: 16px;
            padding: 40px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }
        h2 { color: #f57c00; margin-bottom: 20px; }
        .form-group { margin-bottom: 20px; text-align: left; }
        label { display: block; margin-bottom: 8px; color: #333; font-weight: 600; }
        input {
            width: 100%; padding: 12px; border: 2px solid #e0e0e0;
            border-radius: 10px; font-size: 14px; box-sizing: border-box;
        }
        input:focus { outline: none; border-color: #667eea; }
        button {
            width: 100%; padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border: none; border-radius: 10px;
            font-size: 16px; font-weight: 600; cursor: pointer;
            transition: transform 0.2s;
        }
        button:hover { transform: translateY(-2px); }
        .message { margin-top: 20px; padding: 10px; border-radius: 8px; font-size: 0.9em; display: none; }
        .message.error { background: #ffebee; color: #c62828; }
        .message.success { background: #e8f5e9; color: #2e7d32; }
        .back-link { display: block; margin-top: 20px; color: #666; text-decoration: none; font-size: 0.9em; }
        .back-link:hover { text-decoration: underline; }
    </style>
</head>
<body>

    <div class="card">
        <h2>ğŸ”’ ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì •</h2>
        
        <div id="loadingMsg">í† í°ì„ í™•ì¸ ì¤‘ì…ë‹ˆë‹¤...</div>

        <div id="resetForm" style="display: none;">
            <p style="color: #666; margin-bottom: 20px; font-size: 0.95em;">
                ìƒˆë¡œìš´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.
            </p>
            <div class="form-group">
                <label>ìƒˆ ë¹„ë°€ë²ˆí˜¸</label>
                <input type="password" id="newPassword" placeholder="8ì ì´ìƒ ì…ë ¥">
            </div>
            <div class="form-group">
                <label>ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                <input type="password" id="confirmPassword" placeholder="í•œ ë²ˆ ë” ì…ë ¥">
            </div>
            <button onclick="submitResetPassword()">ë³€ê²½í•˜ê¸°</button>
        </div>

        <div id="messageArea" class="message"></div>

        <a href="index.html" class="back-link">ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ëŒì•„ê°€ê¸°</a>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:8080';
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');

        const loadingMsg = document.getElementById('loadingMsg');
        const resetForm = document.getElementById('resetForm');
        const messageArea = document.getElementById('messageArea');

        // 1. í˜ì´ì§€ ë¡œë“œ ì‹œ í† í° ê²€ì¦
        window.onload = async function() {
            if (!token) {
                showMessage("ìœ íš¨í•˜ì§€ ì•Šì€ ì ‘ê·¼ì…ë‹ˆë‹¤. (í† í° ì—†ìŒ)", "error");
                loadingMsg.style.display = 'none';
                return;
            }

            try {
                // í† í° ìœ íš¨ì„± ê²€ì‚¬ API í˜¸ì¶œ
                const res = await fetch(`${API_BASE_URL}/api/v1/auth/reset-password/${token}`);
                const data = await res.json();

                loadingMsg.style.display = 'none';

                if (res.ok) {
                    // ìœ íš¨í•˜ë©´ í¼ í‘œì‹œ
                    resetForm.style.display = 'block';
                } else {
                    showMessage(data.error || "ìœ íš¨í•˜ì§€ ì•Šê±°ë‚˜ ë§Œë£Œëœ ë§í¬ì…ë‹ˆë‹¤.", "error");
                }
            } catch (e) {
                loadingMsg.style.display = 'none';
                showMessage("ì„œë²„ ì—°ê²° ì‹¤íŒ¨: " + e.message, "error");
            }
        };

        // 2. ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ìš”ì²­
        async function submitResetPassword() {
            const newPw = document.getElementById('newPassword').value;
            const confPw = document.getElementById('confirmPassword').value;

            if (newPw.length < 8) {
                showMessage("ë¹„ë°€ë²ˆí˜¸ëŠ” 8ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.", "error");
                return;
            }
            if (newPw !== confPw) {
                showMessage("ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.", "error");
                return;
            }

            try {
                const res = await fetch(`${API_BASE_URL}/api/v1/auth/reset-password`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token: token, new_password: newPw })
                });
                const data = await res.json();

                if (res.ok) {
                    resetForm.style.display = 'none';
                    showMessage("ë¹„ë°€ë²ˆí˜¸ê°€ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.<br>ì´ì œ ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¡œ ë¡œê·¸ì¸í•˜ì„¸ìš”.", "success");
                } else {
                    showMessage(data.error || "ë³€ê²½ ì‹¤íŒ¨", "error");
                }
            } catch (e) {
                showMessage("ìš”ì²­ ì‹¤íŒ¨: " + e.message, "error");
            }
        }

        function showMessage(msg, type) {
            messageArea.textContent = ''; // ì´ˆê¸°í™”
            messageArea.innerHTML = msg; // HTML íƒœê·¸ í—ˆìš© (<br>)
            messageArea.className = `message ${type}`;
            messageArea.style.display = 'block';
        }
    </script>
</body>
</html>